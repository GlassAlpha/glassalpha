# German Credit Dataset Audit Configuration
# This configuration demonstrates a complete ML audit pipeline for credit risk assessment
# using the German Credit dataset with fairness and bias analysis.

# =============================================================================
# AUDIT PROFILE AND BASIC SETTINGS
# =============================================================================

# Audit profile determines which components and validations are applied
audit_profile: "tabular_compliance"

# Strict mode enforces regulatory compliance requirements
# - Explicit random seeds (no defaults)
# - Locked data schema (no inference)
# - Full manifest generation
# - Deterministic plugin selection
strict_mode: true

# =============================================================================
# MODEL CONFIGURATION
# =============================================================================

model:
  # Model type - triggers XGBoostWrapper from registry
  type: "xgboost"

  # Path to pre-trained model (optional - will train new model if not found)
  # path: "models/german_credit_xgboost.pkl"

  # Additional model parameters (optional)
  params:
    max_depth: 6
    learning_rate: 0.1
    n_estimators: 100
    objective: "binary:logistic"
    eval_metric: "logloss"

# =============================================================================
# DATA CONFIGURATION
# =============================================================================

data:
  # Data will be loaded using German Credit dataset loader
  # This path will be created automatically by the dataset loader
  path: "~/.glassalpha/data/german_credit_processed.csv"

  # Target and feature definitions
  target_column: "credit_risk"

  # Key features for credit risk assessment
  feature_columns:
    - "checking_account_status"
    - "duration_months"
    - "credit_history"
    - "purpose"
    - "credit_amount"
    - "savings_account"
    - "employment_duration"
    - "installment_rate"
    - "personal_status_sex"
    - "other_debtors"
    - "present_residence_since"
    - "property"
    - "age_years"
    - "other_installment_plans"
    - "housing"
    - "existing_credits_count"
    - "job"
    - "dependents_count"
    - "telephone"
    - "foreign_worker"

  # Protected attributes for fairness analysis
  # These are sensitive demographic characteristics that should not lead to discrimination
  protected_attributes:
    - "gender"           # Gender (extracted from personal_status_sex)
    - "age_group"        # Age groups (young, middle_young, middle_aged, senior)
    - "foreign_worker"   # Nationality/residency status

# =============================================================================
# EXPLAINER CONFIGURATION
# =============================================================================

explainers:
  # Strategy for selecting explainers (deterministic for reproducibility)
  strategy: "first_compatible"

  # Priority order - first compatible explainer will be selected
  priority:
    - "treeshap"      # TreeSHAP - exact SHAP values for tree models (preferred)
    - "kernelshap"    # KernelSHAP - model-agnostic fallback
    - "noop"          # No-op fallback (should not be reached)

  # Explainer-specific configuration
  config:
    treeshap:
      # Maximum samples for SHAP value computation
      max_samples: 1000
      # Check additivity property (TreeSHAP should always be additive)
      check_additivity: true

    kernelshap:
      # Number of samples for model-agnostic SHAP approximation
      n_samples: 500
      # Background dataset size for KernelSHAP
      background_size: 100

# =============================================================================
# METRICS CONFIGURATION
# =============================================================================

metrics:
  # Performance metrics for model evaluation
  performance:
    - "accuracy"              # Overall classification accuracy
    - "precision"             # Positive predictive value
    - "recall"                # Sensitivity/true positive rate
    - "f1"                    # Harmonic mean of precision and recall
    - "auc_roc"               # Area under ROC curve
    - "classification_report" # Comprehensive classification metrics

  # Fairness metrics for bias detection
  fairness:
    - "demographic_parity"    # Statistical parity across demographic groups
    - "equal_opportunity"     # Equal true positive rates across groups
    - "equalized_odds"        # Equal TPR and FPR across groups
    - "predictive_parity"     # Equal precision across demographic groups

  # Drift metrics for model stability (requires reference data)
  drift:
    - "population_stability_index"  # PSI for distribution shift detection
    - "kl_divergence"              # KL divergence between distributions
    - "kolmogorov_smirnov"         # Two-sample test for distribution changes

# =============================================================================
# REPRODUCIBILITY CONFIGURATION
# =============================================================================

reproducibility:
  # Master random seed for all randomness sources
  random_seed: 42

  # Enforce deterministic behavior across all components
  deterministic: true

  # Capture complete execution environment
  capture_environment: true

  # Validate deterministic execution
  validate_determinism: true

# =============================================================================
# AUDIT MANIFEST CONFIGURATION
# =============================================================================

manifest:
  # Enable comprehensive audit trail generation
  enabled: true

  # Include Git repository information
  include_git_sha: true

  # Include configuration hash for integrity verification
  include_config_hash: true

  # Include dataset hash for data integrity verification
  include_data_hash: true

  # Include selected component information
  track_component_selection: true

  # Include execution timing and environment
  include_execution_info: true

# =============================================================================
# REPORT CONFIGURATION
# =============================================================================

report:
  # Template for report generation
  template: "standard_audit"

  # Output format (PDF is primary target)
  output_format: "pdf"

  # Report sections to include
  include_sections:
    - "executive_summary"      # High-level findings and risk assessment
    - "data_overview"          # Dataset characteristics and quality
    - "model_performance"      # Performance metrics and validation
    - "global_explanations"    # Feature importance and model behavior
    - "local_explanations"     # Individual prediction explanations
    - "fairness_analysis"      # Bias detection and demographic analysis
    - "drift_detection"        # Model stability and data shift analysis
    - "audit_manifest"         # Complete reproducibility information
    - "regulatory_compliance"  # Compliance checklist and recommendations

  # Report styling and formatting
  styling:
    # Professional color scheme suitable for regulatory submission
    color_scheme: "professional"

    # Include company/organization branding (if applicable)
    # logo_path: "assets/logo.png"

    # Page layout and formatting
    page_size: "A4"
    margins: "standard"

    # Include regulatory compliance statement
    compliance_statement: true

# =============================================================================
# RECOURSE CONFIGURATION (Advanced Feature)
# =============================================================================

recourse:
  # Enable recourse generation for individual predictions
  enabled: true

  # Features that cannot be changed (immutable constraints)
  immutable_features:
    - "age_years"            # Age cannot be changed
    - "gender"               # Gender is protected characteristic
    - "personal_status_sex"  # Personal status is largely fixed
    - "foreign_worker"       # Nationality/residency status

  # Directional constraints (features that can only improve)
  monotonic_constraints:
    credit_amount: "decrease_preferred"      # Lower loan amount is safer
    duration_months: "decrease_preferred"    # Shorter duration is safer
    savings_account: "increase_only"         # More savings is always better
    employment_duration: "increase_only"     # Longer employment is better
    existing_credits_count: "decrease_only"  # Fewer existing credits is better

  # Cost function for feature changes (L1 weighted distance)
  cost_function: "weighted_l1"

  # Feature change costs (higher cost = harder to change)
  feature_costs:
    checking_account_status: 0.8    # Moderate effort to improve account status
    credit_history: 0.9             # Very hard to change credit history
    savings_account: 0.7            # Moderate effort to increase savings
    employment_duration: 0.9        # Hard to change employment quickly
    job: 0.8                        # Moderate effort to change job category
    housing: 0.6                    # Possible to change housing situation
    telephone: 0.1                  # Easy to get telephone

  # Maximum number of recourse examples to generate
  max_recourse_examples: 10

  # Maximum allowed cost for recourse suggestions
  max_total_cost: 3.0

# =============================================================================
# ADVANCED CONFIGURATION
# =============================================================================

# Data preprocessing options
preprocessing:
  # Handle missing values
  handle_missing: true
  missing_strategy: "median"  # For numerical: median, for categorical: mode

  # Feature scaling (important for some explainers)
  scale_features: false  # XGBoost handles raw features well
  scaling_method: "standard"  # standard, minmax, robust

  # Categorical encoding
  categorical_encoding: "label"  # label, onehot, target

  # Feature selection
  feature_selection: false
  selection_method: "mutual_info"
  max_features: 20

# Validation configuration
validation:
  # Cross-validation for model evaluation
  cv_folds: 5
  cv_scoring: "roc_auc"

  # Train/test split configuration
  test_size: 0.2
  stratify_split: true

  # Bootstrap confidence intervals
  bootstrap_samples: 1000
  confidence_level: 0.95

# Performance optimization
performance:
  # Parallel processing
  n_jobs: -1  # Use all available cores

  # Memory optimization
  low_memory_mode: false

  # Progress reporting
  verbose: true
  progress_bar: true

# =============================================================================
# REGULATORY COMPLIANCE SETTINGS
# =============================================================================

compliance:
  # Regulatory frameworks to check against
  frameworks:
    - "gdpr"           # EU General Data Protection Regulation
    - "ecoa"           # US Equal Credit Opportunity Act
    - "fcra"           # US Fair Credit Reporting Act
    - "eu_ai_act"      # EU AI Act (proposed)

  # Bias tolerance thresholds (stricter for regulated use cases)
  fairness_thresholds:
    demographic_parity: 0.05      # 5% maximum difference between groups
    equal_opportunity: 0.05       # 5% maximum TPR difference
    equalized_odds: 0.05          # 5% maximum TPR/FPR difference
    predictive_parity: 0.05       # 5% maximum precision difference

  # Documentation requirements
  documentation:
    model_cards: true             # Generate model cards
    dataset_cards: true           # Generate dataset documentation
    audit_reports: true           # Generate compliance audit reports
    risk_assessments: true        # Generate algorithmic risk assessments

  # Approval workflows (for production deployment)
  approval_required: false        # Set to true for production
  approver_roles:
    - "model_validator"
    - "compliance_officer"
    - "legal_reviewer"

# =============================================================================
# ENVIRONMENT-SPECIFIC OVERRIDES
# =============================================================================

# Development environment settings
development:
  # Use smaller datasets for faster iteration
  sample_size: 500
  # Reduced validation for speed
  cv_folds: 3
  # Less strict fairness requirements
  fairness_thresholds:
    demographic_parity: 0.10

# Production environment settings
production:
  # Full dataset and rigorous validation
  sample_size: null
  cv_folds: 10
  # Strict fairness requirements
  fairness_thresholds:
    demographic_parity: 0.02
  # Required approvals
  approval_required: true
